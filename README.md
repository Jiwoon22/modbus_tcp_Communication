[Modbus TCP 프로토콜 통신]

프로토콜 통신에 대해서는 대학교 시절 tcp와 udp 프로토콜 통신을 경험해본 적이 있다.
하지만 그 당시에는 프로토콜의 개념과 프로토콜 통신에 대한 개념을 모른 채로 어찌저찌 프로젝트를 끝냈었다.

최근에는 modbus 프로토콜이라는 것을 활용해서 데이터를 주고받는 코드를 작성했다.
그러고 나서 프로토콜이란 무엇인지, 프로토콜 통신이란 어떻게 이루어지는 것인지에 대해서 감을 잡게 된 거 같다.

우선 프로토콜이란 쉽게 말해 서로 간의 약속이다.

이런 예시가 맞을 지는 모르겠지만 한 번 들어보겠다.
한국에서는 한국말을 쓴다.
이것은 한국에 사는 사람들끼리 암묵적으로 정해진 약속이다.
고로 ‘한국에 사는 사람들은 한국어를 사용한다‘가 프로토콜(약속)이고
’한국에 사는 사람들은 서로 한국어를 통해서 대화(통신)을 하는 것’이 프로토콜 통신인 것이다.
프로토콜 통신을 ‘정해진 약속으로 통신을 한다!’ - 저는 이렇게 이해했습니다.

이제는 앞서 말했던 modbus 프로토콜 통신에 대해 얘기해보겠습니다.

modbus 프로토콜 통신을 잘라서 해석해보면
modbus 라는 약속이 있고 이 약속을 지키면서 통신을 하겠다. 라는 의미입니다.

그러면 제일 먼저 할 것은 modbus는 어떤 규칙(약속)을 가지고 있는지 찾아봐야 합니다.

인터넷에 찾아보시면 여러 가지 정보가 있을 것이지만 저는 데이터를 읽고 쓰는 것만을 구현해봤습니다.

구성은 다음과 같이 했습니다.





중간에 위치한 노란색 장비는 modbus tcp 프로토콜을 기반으로 데이터를 주고받는 장치이며
나중에는 서버 역할을 하는 장비입니다.

pc는 클라이언트 역할을 하며 장비에 특정 명령어를 전송해서 데이터를 읽어오고 데이터를 쓰는 역할을 합니다.

우선 노란 장치와 통신을 하기 위해서는 장치의 ip와 port를 알아야 합니다.
그 정보를 알기 위해서는 해당 장치의 매뉴얼을 확인하면 알 수 있습니다.

장치의 ip와 port는 “192.168.0.161:502”입니다.

이제 통신을 하는 일이 남았습니다.

해당 장치는 서버 역할 pc는 클라이언트 역할이므로 그에 맞게 코드를 작성합니다.

코드 구성은 크게
- connect
- read
- write
3개로 나눴습니다.


[connect 메서드]

![image](https://github.com/Jiwoon22/modbus_tcp_Communication/assets/51106092/6b744ac7-4437-4828-ace4-d991da9b36f3)

저는 데이터를 읽어오는 ‘read_client’와 데이터를 쓰는 ‘write_client’를 나눴습니다.
그 후에는 “192.168.0.161:502”로 접속을 합니다.
(winform으로 코딩을 한 거라 ip와 port를 textbox에서 가져오는 방식으로 했습니다.)



[read 메서드]

![image](https://github.com/Jiwoon22/modbus_tcp_Communication/assets/51106092/3e3eca2f-a61e-4500-a185-6a2b4df26177)


read함수는 현재 장치의 데이터를 읽어오는 기능을 합니다.
그 데이터는 장치의 0번 출력포트에서 7번 출력포트의 데이터에 해당합니다.
데이터는 on/off로 그 포트가 켜져있는지 꺼져있는지를 의미하는 데이터입니다.

데이터 형식은 byte배열로 이루어져있으며 각각의 byte가 의미하는 것은 위 코드의 주석과 같습니다. 그 중에 중요한 것은 함수 코드(0x01)입니다. 함수 코드 01은 read 기능입니다.

따라서 함수를 읽어오는데 어디서 얼마나 읽어올지 에 대한 정보를 담은 byte배열을 서버에 전송하면 데이터를 읽어올 수 있습니다.



